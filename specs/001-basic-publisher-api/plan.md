# Implementation Plan: Basic NatsPublisher API (MVP)

**Branch**: `001-basic-publisher-api` | **Date**: 2025-10-25 | **Spec**: `/specs/001-basic-publisher-api/spec.md`
**Input**: Feature specification from `/specs/001-basic-publisher-api/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command and outlines the MVP for a minimal NatsPublisher.

## Summary

Create an untyped, simple `NatsPublisher` class that can be injected via Quarkus CDI and publish raw string messages to a NATS subject named `test`. This MVP validates the core extension architecture (runtime module, CDI integration, singleton connection) before adding type generics, CloudEvents support, or configuration options. The feature will be integration-tested against a local NATS broker.

## Technical Context

**Language/Version**: Java 21 (enforced per Principle IV)
**Primary Dependencies**:
  - Quarkus 3.27.0 (core framework)
  - io.nats:jnats (NATS JetStream client)
  - quarkus-arc (CDI dependency injection)
  - No additional runtime dependencies

**Storage**: N/A (publisher only; no persistence in this MVP)

**Testing**:
  - JUnit 5 (via Quarkus test framework)
  - @QuarkusTest integration test support
  - Local NATS broker (Docker or binary) for contract testing

**Target Platform**: Linux/macOS with Java 21 runtime

**Development Environment**:
  - NATS broker: Docker Compose via `integration-tests/docker-compose-devservices.yml`
  - Stack includes: NATS (with JetStream) + LGTM observability (Grafana/OpenTelemetry)
  - Credentials: username=`guest`, password=`guest`
  - Startup: `docker-compose -f integration-tests/docker-compose-devservices.yml up -d`
  - Shutdown: `docker-compose -f integration-tests/docker-compose-devservices.yml down`

**Project Type**: Quarkus extension (multi-module Maven: runtime + deployment)

**Performance Goals**: <100ms end-to-end publish latency on localhost

**Constraints**:
  - Runtime module JAR â‰¤ 500 KB (Principle II)
  - Zero additional dependencies beyond Arc + JNats
  - Must compile to native image (GraalVM, future gate)

**Scale/Scope**: MVP for single NATS subject ("test"); no configuration, no scaling concerns yet

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Principle Alignment**:

| Principle | Requirement | Status | Notes |
|-----------|-------------|--------|-------|
| I. Extension-First Architecture | Runtime/deployment split; no non-Arc deps in runtime | âœ… PASS | Will implement in runtime module with minimal Arc dependency |
| II. Minimal Runtime Dependencies | JetStream only, <500KB JAR, singleton connection | âœ… PASS | Publisher depends only on io.nats:jnats; singleton will be enforced |
| III. Test-Driven Development | Unit + integration tests, >80% coverage | âœ… PASS | TDD required; contract test with local NATS broker included |
| IV. Java 21 Compatibility | All code targets Java 21 | âœ… PASS | Project already enforces java.compiler.release=21 |
| V. CloudEvents Compliance | N/A | ðŸ”„ DEFERRED | MVP excludes CloudEvents; future feature |
| VI. Developer Experience First | Annotation-driven, type-safe, minimal boilerplate | âœ… PASS | `@Inject` + `NatsPublisher` injection pattern implements this MVP |
| VII. Observability First | Tracing + health checks | ðŸ”„ DEFERRED | MVP excludes observability; future feature |

**Gate Result**: âœ… **PASS** - No principle violations. Deferred features (V, VII) are explicitly out-of-scope for MVP.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
runtime/src/main/java/io/quarkus/easynats/
â”œâ”€â”€ NatsPublisher.java          # Simple publisher facade (publish(String) method)
â””â”€â”€ NatsConnectionManager.java  # Singleton connection lifecycle management

deployment/src/main/java/io/quarkus/easynats/deployment/
â”œâ”€â”€ QuarkusEasyNatsProcessor.java  # Build-time registration (@BuildStep)
â””â”€â”€ NatsFeature.java               # Feature descriptor for Quarkus

integration-tests/src/main/java/io/quarkus/easynats/it/
â”œâ”€â”€ BasicPublisherTest.java     # @QuarkusTest base test class (dev mode, reusable test methods)
â””â”€â”€ BasicPublisherIT.java       # @QuarkusIntegrationTest extends BasicPublisherTest (full integration)

integration-tests/docker-compose-devservices.yml (EXISTING)
# Reuses existing NATS + LGTM observability stack
```

**Structure Decision**: Multi-module Quarkus extension following the prescribed layout:
- **runtime**: Production code (NatsPublisher, connection manager); no unit tests here
- **deployment**: Build-time processors that register NatsPublisher as a CDI bean
- **integration-tests**:
  - Test classes in `src/main/java/io/quarkus/easynats/it/`
    - `BasicPublisherTest.java` with `@QuarkusTest`: Dev mode, reusable test methods
    - `BasicPublisherIT.java` with `@QuarkusIntegrationTest` extends `BasicPublisherTest`: Full integration against docker-compose
  - NATS broker: Reuses existing `docker-compose-devservices.yml` at project root (NATS 2.11 + LGTM stack)

## Complexity Tracking

No constitution violations. All design choices align with declared principles.
