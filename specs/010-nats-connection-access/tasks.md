# Implementation Tasks: NATS Connection Access API

**Feature**: 010-nats-connection-access | **Date**: 2025-10-28
**Branch**: `010-nats-connection-access` | **Spec**: `specs/010-nats-connection-access/spec.md`

**Status**: Generated by `/speckit.tasks` command

---

## Overview

This document breaks down Feature 010 (NATS Connection Access API) into actionable, independently testable tasks organized by user story and phase. All tasks follow TDD (Test-Driven Development) principles: unit tests are written before implementation.

### User Stories Prioritization

| Story | Title | Priority | MVP? |
|-------|-------|----------|------|
| US1 | Access Raw NATS Connection | P1 | ✅ Yes |
| US2 | Thread-Safe Connection Access | P1 | ✅ Yes |
| US3 | Safe Connection Lifecycle Management | P2 | ❌ No |
| US4 | CDI Injection for Connection Access | P1 | ✅ Yes |
| US5 | Try-with-Resources Support | P2 | ❌ No |
| US6 | Configuration via ENV/Properties | P1 | ✅ Yes |

**MVP Scope**: Phase 1-2 (Setup + Foundational) + Phase 3 (US1) + Phase 4 (US2, US4, US6)

---

## Phase 1: Project Setup & Structure

**Goal**: Initialize runtime, deployment, and integration test modules with base project structure.
**Dependencies**: None
**Parallel opportunities**: All setup tasks can run in parallel

- [ ] T001 Create NatsConnection wrapper class structure in `runtime/src/main/java/org/mjelle/quarkus/easynats/NatsConnection.java` with package-private constructor and delegate field
- [ ] T002 Create NatsConfiguration class in `runtime/src/main/java/org/mjelle/quarkus/easynats/runtime/NatsConfiguration.java` as a @ConfigMapping for Quarkus properties
- [ ] T003 Create NatsConnectionProvider class in `runtime/src/main/java/org/mjelle/quarkus/easynats/runtime/NatsConnectionProvider.java` as @Singleton CDI bean
- [ ] T004 Create QuarkusEasyNatsProcessor class in `deployment/src/main/java/org/mjelle/quarkus/easynats/deployment/QuarkusEasyNatsProcessor.java` with @BuildStep methods
- [ ] T005 Create integration test resource `integration-tests/src/main/java/org/mjelle/quarkus/easynats/it/OrderListener.java` for message capture
- [ ] T006 Create integration test resource `integration-tests/src/main/java/org/mjelle/quarkus/easynats/it/OrderResource.java` for REST endpoints
- [ ] T007 Create integration test resource `integration-tests/src/main/java/org/mjelle/quarkus/easynats/it/NatsTestResource.java` as Quarkus test resource for NATS server setup

---

## Phase 2: Foundational (Blocking Prerequisites)

**Goal**: Implement core wrapper delegation, configuration loading, and CDI registration infrastructure that all user stories depend on.
**Dependencies**: Phase 1
**Parallel opportunities**: Configuration and delegation can be developed in parallel

### 2A: NatsConnection Delegation Implementation

- [ ] T008 Implement delegation methods in NatsConnection: `publish(String subject, byte[] data)` and `publish(String subject, Headers headers, byte[] data)`
- [ ] T009 Implement subscription delegation methods: `subscribe(String subject)` and `createDispatcher(MessageHandler handler)`
- [ ] T010 Implement JetStream delegation methods: `createJetStreamContext()` and `createJetStreamContext(JetStreamOptions options)`
- [ ] T011 Implement metadata delegation methods: `getServerInfo()`, `getConnectedUrl()`, `getStatus()`
- [ ] T012 Implement listener delegation methods: `setConnectionListener(ConnectionListener listener)` and `getConnectionListener()`
- [ ] T013 Implement key-value delegation methods: `keyValue(String bucketName)` and `keyValueManagement()`
- [ ] T014 Implement AutoCloseable interface in NatsConnection with no-op `close()` method that does nothing and never throws
- [ ] T015 Add isClosed() delegation method to NatsConnection

### 2B: NatsConfiguration Implementation

- [ ] T016 Implement NatsConfiguration with `@ConfigMapping(prefix = "quarkus.easynats")` annotation
- [ ] T017 Add configuration properties to NatsConfiguration: `servers` (String list), `username` (optional String), `password` (optional String), `sslEnabled` (optional Boolean, default false)
- [ ] T018 Implement configuration validation in NatsConfiguration: ensure servers is not empty, both username AND password required together
- [ ] T019 Add validation error method to NatsConfiguration that throws NatsConfigurationException with clear message for invalid credentials (username without password)

### 2C: NatsConnectionProvider Implementation

- [ ] T020 Implement NatsConnectionProvider to read NatsConfiguration and establish connection via `Nats.connect(options)`
- [ ] T021 Add logic to NatsConnectionProvider to inject default `SSLContext` into Options when `sslEnabled=true`
- [ ] T022 Add connection initialization validation to NatsConnectionProvider: fail if connection is null or closed
- [ ] T023 Implement lifecycle method in NatsConnectionProvider to close connection gracefully on app shutdown

### 2D: Build-Time Processor Registration

- [ ] T024 Implement QuarkusEasyNatsProcessor to register NatsConnectionProvider as a synthetic bean using @BuildStep
- [ ] T025 Implement QuarkusEasyNatsProcessor to register NatsConnection as a synthetic bean using @BuildStep with dependency on NatsConnectionProvider
- [ ] T026 Add build-time validation to QuarkusEasyNatsProcessor to fail at build time if configuration is invalid

### 2E: Unit Tests for Wrapper Delegation (TDD)

- [ ] T027 Create `runtime/src/test/java/org/mjelle/quarkus/easynats/NatsConnectionTest.java` with test cases for wrapper delegation
- [ ] T028 [P] Add unit test to NatsConnectionTest: verify publish() method delegates to underlying connection without modification
- [ ] T029 [P] Add unit test to NatsConnectionTest: verify subscribe() method delegates and returns Subscription
- [ ] T030 [P] Add unit test to NatsConnectionTest: verify createDispatcher() delegates and returns Dispatcher
- [ ] T031 [P] Add unit test to NatsConnectionTest: verify createJetStreamContext() delegates and returns context
- [ ] T032 [P] Add unit test to NatsConnectionTest: verify getServerInfo() delegates and returns ServerInfo
- [ ] T033 [P] Add unit test to NatsConnectionTest: verify setConnectionListener() delegates to underlying connection
- [ ] T034 [P] Add unit test to NatsConnectionTest: verify keyValue() and keyValueManagement() methods delegate
- [ ] T035 Add unit test to NatsConnectionTest: verify close() is a safe no-op (doesn't throw, doesn't close delegate)
- [ ] T036 Add unit test to NatsConnectionTest: verify isClosed() delegates to underlying connection.isClosed()

### 2F: Unit Tests for Configuration

- [ ] T037 Create `runtime/src/test/java/org/mjelle/quarkus/easynats/runtime/NatsConfigurationTest.java` for configuration validation tests
- [ ] T038 [P] Add unit test: valid configuration with servers and no auth is accepted
- [ ] T039 [P] Add unit test: valid configuration with servers, username, and password is accepted
- [ ] T040 [P] Add unit test: invalid configuration with only username (no password) throws NatsConfigurationException
- [ ] T041 [P] Add unit test: invalid configuration with only password (no username) throws NatsConfigurationException
- [ ] T042 [P] Add unit test: empty servers list throws NatsConfigurationException
- [ ] T043 [P] Add unit test: configuration properties are correctly read from MicroProfile Config

### 2G: Unit Tests for NatsConnectionProvider

- [ ] T044 Create `runtime/src/test/java/org/mjelle/quarkus/easynats/runtime/NatsConnectionProviderTest.java` for provider tests
- [ ] T045 [P] Add unit test: NatsConnectionProvider successfully establishes connection with valid configuration
- [ ] T046 [P] Add unit test: NatsConnectionProvider injects default SSLContext when ssl-enabled=true
- [ ] T047 [P] Add unit test: provider wraps underlying connection in NatsConnection wrapper

---

## Phase 3: US1 - Access Raw NATS Connection for Advanced Operations

**Goal**: Enable developers to inject and use NatsConnection for any NATS operation.
**Priority**: P1
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US2, US4, US6 after Phase 2
**Independent Test**: Developer can publish and receive messages using injected connection

### 3A: Integration Tests (TDD)

- [ ] T048 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/NatsConnectionAccessTest.java` using @QuarkusTest
- [ ] T049 Add test to NatsConnectionAccessTest: developer can inject NatsConnection and receive it as a valid, open connection
- [ ] T050 Add test to NatsConnectionAccessTest: developer can use injected connection to publish a message to a subject
- [ ] T051 Add test to NatsConnectionAccessTest: developer can create a subscription via connection and receive published messages
- [ ] T052 Add test to NatsConnectionAccessTest: multiple subscriptions can receive messages from the same published message

### 3B: Integration Test Infrastructure

- [ ] T053 Create REST endpoint in OrderResource: `GET /connection/info` that returns server info from injected NatsConnection (verifies connection is accessible)
- [ ] T054 Create REST endpoint in OrderResource: `POST /connection/publish/{subject}` that publishes a message via injected connection
- [ ] T055 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/NatsConnectionAccessIT.java` extending NatsConnectionAccessTest with @QuarkusIntegrationTest

### 3C: Documentation

- [ ] T056 Add section to quickstart.md: "Basic Usage: Access Raw Connection" with example of injecting and using connection
- [ ] T057 Update CLAUDE.md with NatsConnection as a new active technology

---

## Phase 4: US2 - Thread-Safe Connection Access (Parallel with US4, US6)

**Goal**: Verify wrapper properly delegates concurrent operations without introducing thread-safety issues.
**Priority**: P1
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US4, US6
**Independent Test**: Multiple threads safely use wrapper without deadlocks or state corruption

### 4A: Unit Tests for Thread Safety (TDD)

- [ ] T058 [P] Create unit test in NatsConnectionTest: multiple threads concurrently invoke publish() through wrapper - verify no exceptions and no deadlocks
- [ ] T059 [P] Add unit test: multiple threads concurrently invoke subscribe() - verify subscribers created without blocking
- [ ] T060 [P] Add unit test: mixed concurrent operations (publish + subscribe + getServerInfo) - verify no state corruption
- [ ] T061 [P] Add unit test: concurrent close() calls (no-op) - verify no exceptions

### 4B: Integration Tests

- [ ] T062 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/ThreadSafetyTest.java` using @QuarkusTest
- [ ] T063 Add test: spawn 10 threads, each publishes 100 messages concurrently - verify all messages published successfully
- [ ] T064 Add test: spawn 5 publisher threads + 5 subscriber threads - verify no deadlocks and messages flow correctly
- [ ] T065 Create `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/ThreadSafetyIT.java` extending ThreadSafetyTest with @QuarkusIntegrationTest

---

## Phase 4: US4 - CDI Injection for Connection Access (Parallel with US2, US6)

**Goal**: Enable CDI injection of NatsConnection as a singleton bean.
**Priority**: P1
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US2, US6
**Independent Test**: Developer can inject connection via constructor injection and receives singleton

### 4C: Unit Tests for CDI Registration (TDD)

- [ ] T066 Create unit test in QuarkusEasyNatsProcessorTest: verify build step registers NatsConnection as @Singleton bean
- [ ] T067 Add unit test: verify NatsConnectionProvider is registered as @Singleton dependency
- [ ] T068 Add unit test: verify bean instantiation succeeds with valid configuration

### 4D: Integration Tests for CDI Injection

- [ ] T069 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/CDIInjectionTest.java` using @QuarkusTest
- [ ] T070 Add test: create two beans that inject NatsConnection via constructor - verify they receive the same singleton instance
- [ ] T071 Add test: RestAssured call to REST endpoint that uses injected connection - verify endpoint works and accesses same connection
- [ ] T072 Add test: verify injected connection is same instance as used internally by extension components (access via test endpoint)
- [ ] T073 Add test: verify pre-initialization injection fails with clear error (attempt to access connection in @PostConstruct of startup bean)
- [ ] T074 Create `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/CDIInjectionIT.java` extending CDIInjectionTest with @QuarkusIntegrationTest

### 4E: Integration Test Infrastructure

- [ ] T075 Create second test bean `integration-tests/src/main/java/org/mjelle/quarkus/easynats/it/AnalyticsService.java` that injects NatsConnection for verifying singleton sharing

---

## Phase 4: US6 - Configuration via ENV/Properties (Parallel with US2, US4)

**Goal**: Enable configuration of NATS connection via environment variables and application.properties.
**Priority**: P1
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US2, US4
**Independent Test**: Configuration loads from ENV vars and properties file; servers, auth, SSL configured correctly

### 4F: Configuration File Setup

- [ ] T076 Create `integration-tests/src/test/resources/application-test-config.properties` with test configuration: servers, username, password, ssl-enabled

### 4G: Unit Tests for Configuration Loading

- [ ] T077 Add unit test to NatsConfigurationTest: configuration loads from Quarkus MicroProfile Config
- [ ] T078 [P] Add unit test: ENV variable `QUARKUS_EASYNATS_SERVERS` overrides properties file value
- [ ] T079 [P] Add unit test: ENV variable `QUARKUS_EASYNATS_USERNAME` is read correctly
- [ ] T080 [P] Add unit test: ENV variable `QUARKUS_EASYNATS_PASSWORD` is read correctly
- [ ] T081 [P] Add unit test: ENV variable `QUARKUS_EASYNATS_SSL_ENABLED` is converted to boolean correctly

### 4H: Integration Tests for Configuration

- [ ] T082 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/ConfigurationTest.java` using @QuarkusTest
- [ ] T083 Add test with custom application profile: application loads with servers from application.properties
- [ ] T084 Add test: application startup fails with clear error when servers not configured
- [ ] T085 Add test: application startup fails with clear error when username provided without password
- [ ] T086 Add test: application startup fails with clear error when password provided without username
- [ ] T087 Add test: server info returned shows correct NATS server address from configuration
- [ ] T088 Add test: application startup fails with clear error when server address is invalid/unreachable
- [ ] T089 Create `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/ConfigurationIT.java` extending ConfigurationTest with @QuarkusIntegrationTest

### 4I: Documentation for Configuration

- [ ] T090 Add section to quickstart.md: "Configuration" with ENV variable and properties file examples
- [ ] T091 Update plan.md Configuration section with detailed examples of each property

---

## Phase 5: US3 - Safe Connection Lifecycle Management (Parallel with US5)

**Goal**: Ensure connection remains open during app runtime and closes gracefully on shutdown.
**Priority**: P2
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US5
**Independent Test**: Connection remains open during app lifetime and closes on shutdown

### 5A: Unit Tests for Lifecycle

- [ ] T092 Create unit test in NatsConnectionProviderTest: provider maintains open connection for app lifetime
- [ ] T093 Add unit test: provider calls close() on underlying connection during shutdown
- [ ] T094 Add unit test: verify no resource leaks (provider doesn't leave orphaned resources)

### 5B: Integration Tests for Lifecycle

- [ ] T095 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/LifecycleTest.java` using @QuarkusTest
- [ ] T096 Add test: application starts successfully and connection is ready for injection
- [ ] T097 Add test: connection can be used immediately after application startup
- [ ] T098 Add test: multiple REST calls over extended period verify connection remains open
- [ ] T099 Create `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/LifecycleIT.java` extending LifecycleTest with @QuarkusIntegrationTest

---

## Phase 5: US5 - Try-with-Resources Support (Parallel with US3)

**Goal**: Enable safe use of connection in try-with-resources blocks.
**Priority**: P2
**Dependencies**: Phase 2
**Parallel opportunities**: Can run in parallel with US3
**Independent Test**: Try-with-resources works; connection remains open after try block exits

### 5C: Unit Tests for Try-with-Resources

- [ ] T100 Add unit test to NatsConnectionTest: close() method implements no-op behavior - can be called without exception
- [ ] T101 Add unit test: close() does not affect underlying connection (connection.isClosed() returns false after close())
- [ ] T102 Add unit test: try-with-resources syntax compiles and executes without error

### 5D: Integration Tests for Try-with-Resources

- [ ] T103 Create integration test class `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/TryWithResourcesTest.java` using @QuarkusTest
- [ ] T104 Add test: use connection in try-with-resources block - verify no-op close
- [ ] T105 Add test: publish message in try block, then use connection in another method after try block exits - verify connection still works
- [ ] T106 Add test: exception thrown in try block - close() called, connection still usable for recovery
- [ ] T107 Create `integration-tests/src/test/java/org/mjelle/quarkus/easynats/it/TryWithResourcesIT.java` extending TryWithResourcesTest with @QuarkusIntegrationTest

### 5E: Documentation

- [ ] T108 Add section to quickstart.md: "Safe: Try-with-Resources" with examples and explanation of no-op close

---

## Phase 6: Polish & Cross-Cutting Concerns

**Goal**: Complete documentation, verify all success criteria, and ensure production readiness.
**Dependencies**: Phases 1-5
**Parallel opportunities**: Documentation tasks can run in parallel

### 6A: Refactor Existing Components to Use NatsConnection

- [ ] T109 Refactor `NatsPublisher` to inject and use NatsConnection internally instead of separate connection reference
- [ ] T110 Refactor `NatsSubscriber` to inject and use NatsConnection internally
- [ ] T111 Refactor `NatsMessageHandler` to use injected NatsConnection
- [ ] T112 Refactor `NatsMessageDeserializer` to receive NatsConnection via constructor injection if needed
- [ ] T113 Verify existing tests still pass after refactoring to use NatsConnection

### 6B: User Documentation

- [ ] T114 Create user-facing guide from quickstart.md in appropriate documentation location
- [ ] T115 Add prominent warning in documentation: "DO NOT call close() on NatsConnection - the connection is shared"
- [ ] T116 Add section to documentation: "Advanced Examples" showing metadata access, keyValue access, and keyValueManagement
- [ ] T117 Add section to documentation: "Testing" showing how to use @QuarkusTest with injected NatsConnection
- [ ] T118 Add "Reconnection Handling" section explaining that jnats handles reconnection automatically

### 6C: Success Criteria Validation

- [ ] T119 Verify SC-001: Developers can execute any NATS operation within 30 seconds of reading documentation
- [ ] T120 Verify SC-002: Wrapper delegation doesn't introduce deadlocks or synchronization bottlenecks
- [ ] T121 Verify SC-003: Advanced NATS API is intuitive to use (manual verification/UX review)
- [ ] T122 Verify SC-004: No connection-related resource leaks (extend integration tests over longer runtimes)
- [ ] T123 Verify SC-005: Operations complete within 5% latency overhead (performance measurement in integration tests)
- [ ] T124 Verify SC-006: Try-with-resources support works with zero side effects
- [ ] T125 Verify SC-007: Configuration can be completed in <5 minutes (documented examples sufficient)
- [ ] T126 Verify SC-008: Configuration via ENV vars and properties works identically with correct precedence
- [ ] T127 Verify SC-009: 100% of configuration errors produce clear, actionable startup messages

### 6D: Code Quality & Testing

- [ ] T128 [P] Ensure >80% code coverage in runtime module unit tests
- [ ] T129 [P] Ensure all integration tests pass both on JVM (@QuarkusTest) and native image (@QuarkusIntegrationTest)
- [ ] T130 [P] Run full build with `-Pit` flag to validate native image compilation
- [ ] T131 Add code comments explaining wrapper delegation pattern and why close() is no-op

### 6E: Final Review & Commit

- [ ] T132 Update CLAUDE.md with active technologies: Java 21, Quarkus 3.27.0, jnats, Quarkus Arc
- [ ] T133 Review all code against CLAUDE.md coding guidelines (constructor injection, AssertJ, Awaitility, no @Inject in production code)
- [ ] T134 Ensure all files follow project conventions (package structure, naming, documentation)
- [ ] T135 Create final commit with message summarizing feature completion

---

## Implementation Strategy

### MVP (Minimum Viable Product) - Phase 3 Focus

The MVP scope includes Phase 1 (Setup) + Phase 2 (Foundational) + Phase 3 (US1):
- Developers can inject NatsConnection
- Can use it to publish and subscribe
- Thread-safety is guaranteed by delegation
- Configuration works via properties

This delivers the core value: **easy and safe access to connection for advanced operations**.

### Incremental Delivery

1. **Sprint 1**: Phase 1 + Phase 2 (setup and foundational infrastructure)
2. **Sprint 2**: Phase 3 + Phase 4 (US1, US2, US4, US6 - all P1 stories)
3. **Sprint 3**: Phase 5 (US3, US5 - P2 stories)
4. **Sprint 4**: Phase 6 (Polish, documentation, refactoring)

### Parallelization Opportunities

**After Phase 2 completes, all P1 user story phases can run in parallel:**
- US1 (Access Raw Connection)
- US2 (Thread-Safe Access)
- US4 (CDI Injection)
- US6 (Configuration)

**After Phase 4 completes, P2 user story phases can run in parallel:**
- US3 (Lifecycle Management)
- US5 (Try-with-Resources)

### Testing Strategy

- **Unit tests** (TDD): Written first, focus on wrapper delegation and configuration
- **Integration tests**: Verify end-to-end scenarios with real Quarkus app and NATS server
- **Native image tests** (`*IT` classes): Validate feature works in both JVM and native image modes

### Key Design Points to Verify

1. **Single Singleton**: All beans receive same NatsConnection instance
2. **Safe close()**: No-op implementation; underlying connection never closed by wrapper
3. **Configuration Validation**: Both username AND password required; clear error messages
4. **Fail-Fast**: Pre-initialization injection fails immediately with clear error
5. **Transparent Delegation**: No performance overhead; all operations forward to underlying connection
6. **Listener Support**: ConnectionListener delegation enabled for Feature 011 (health checks)

---

## Task Statistics

| Metric | Count |
|--------|-------|
| **Total Tasks** | 135 |
| **Phase 1 (Setup)** | 7 |
| **Phase 2 (Foundational)** | 29 |
| **Phase 3 (US1)** | 9 |
| **Phase 4 (US2, US4, US6)** | 42 |
| **Phase 5 (US3, US5)** | 15 |
| **Phase 6 (Polish)** | 33 |
| **Parallelizable tasks [P]** | 45 |
| **TDD tests (before implementation)** | 48 |

---

## File Structure Reference

```
runtime/src/
├── main/java/org/mjelle/quarkus/easynats/
│   ├── NatsConnection.java                      (T001, Phase 2A-E)
│   └── runtime/
│       ├── NatsConfiguration.java               (T002, Phase 2B)
│       └── NatsConnectionProvider.java          (T003, Phase 2C)
└── test/java/org/mjelle/quarkus/easynats/
    ├── NatsConnectionTest.java                  (T027, Phase 2E)
    └── runtime/
        ├── NatsConfigurationTest.java           (T037, Phase 2F)
        └── NatsConnectionProviderTest.java      (T044, Phase 2G)

deployment/src/main/java/org/mjelle/quarkus/easynats/deployment/
└── QuarkusEasyNatsProcessor.java                (T004, Phase 2D)

integration-tests/src/
├── main/java/org/mjelle/quarkus/easynats/it/
│   ├── OrderListener.java                       (T005)
│   ├── OrderResource.java                       (T006)
│   ├── NatsTestResource.java                    (T007)
│   └── AnalyticsService.java                    (T075)
└── test/java/org/mjelle/quarkus/easynats/it/
    ├── NatsConnectionAccessTest.java            (T048, Phase 3A)
    ├── NatsConnectionAccessIT.java              (T055, Phase 3B)
    ├── ThreadSafetyTest.java                    (T062, Phase 4B)
    ├── ThreadSafetyIT.java                      (T065, Phase 4B)
    ├── CDIInjectionTest.java                    (T069, Phase 4D)
    ├── CDIInjectionIT.java                      (T074, Phase 4D)
    ├── ConfigurationTest.java                   (T082, Phase 4H)
    ├── ConfigurationIT.java                     (T089, Phase 4H)
    ├── LifecycleTest.java                       (T095, Phase 5B)
    ├── LifecycleIT.java                         (T099, Phase 5B)
    ├── TryWithResourcesTest.java                (T103, Phase 5D)
    └── TryWithResourcesIT.java                  (T107, Phase 5D)

specs/010-nats-connection-access/
├── plan.md                                      (updated by T091)
└── quickstart.md                                (updated by T056, T090, T108, T118)
```

---

## Dependencies & Execution Order

### Critical Path (Blocking Dependencies)

1. **Phase 1** → All others depend on project structure
2. **Phase 2** → Phases 3-5 all depend on foundational infrastructure
3. **Phase 3** → Validates basic access works
4. **Phases 4 & 5** → Can run in parallel after Phase 2

### User Story Completion Order

```
Setup (Phase 1)
    ↓
Foundational (Phase 2)
    ↓
    ├─ Phase 3: US1 (Raw Connection Access) ✓ P1 MVP
    ├─ Phase 4: US2, US4, US6 (Thread-Safety, CDI, Config) ✓ P1 MVP
    │   └─ Can run in parallel
    └─ Phase 5: US3, US5 (Lifecycle, Try-with-Resources) ✓ P2
        └─ Can run in parallel after Phase 4
    ↓
Polish (Phase 6)
```

---

## Success Metrics

All tasks must result in:
- ✅ Passing unit tests (TDD)
- ✅ Passing integration tests (@QuarkusTest)
- ✅ Passing native image tests (@QuarkusIntegrationTest with -Pit)
- ✅ Code coverage >80%
- ✅ Zero warnings in maven build
- ✅ Clear error messages for all failure scenarios
- ✅ Complete documentation with examples

---

## Notes for Implementation

1. **TDD Approach**: Write tests before implementation. Each test task (T027-T044, etc.) should be completed before the corresponding implementation task.
2. **Constructor Injection Only**: All CDI beans must use constructor injection, never field injection (per CLAUDE.md).
3. **AssertJ for Tests**: All assertions must use AssertJ, never JUnit assertions (per CLAUDE.md).
4. **Awaitility for Async**: Integration tests must use Awaitility for async waiting, never Thread.sleep() (per CLAUDE.md).
5. **No @Inject in Production**: Field injection is forbidden in runtime and deployment modules.
6. **Test Resource Naming**: Follow pattern: `*Test` for JVM tests (@QuarkusTest), `*IT` for native tests (@QuarkusIntegrationTest).
7. **REST Endpoints Only**: Integration tests access functionality through REST endpoints or static utilities, never field injection.
