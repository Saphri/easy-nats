name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      next-version:
        description: 'Next development version (e.g., 1.1.0-SNAPSHOT)'
        required: true
        type: string
      validate-native:
        description: 'Validate native compatibility (slower but ensures extension works in native mode)'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 21 (Temurin)
        if: ${{ !inputs.validate-native }}
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Set up Mandrel (for native validation)
        if: ${{ inputs.validate-native }}
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'mandrel'
          java-version: '21'
          version: '23.1.5.0-Final'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Verify Mandrel setup (for native validation)
        if: ${{ inputs.validate-native }}
        run: |
          echo "GRAALVM_HOME: $GRAALVM_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          native-image --version

      - name: Configure Maven settings for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>\${env.GITHUB_ACTOR}</username>
                <password>\${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "Maven settings.xml created with GitHub authentication"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set release version
        run: |
          ./mvnw -B versions:set -DnewVersion=${{ inputs.version }} -DprocessAllModules=true
          git add pom.xml */pom.xml
          git commit -m "chore: release version ${{ inputs.version }}"

      - name: Build and test extension (JVM mode)
        if: ${{ !inputs.validate-native }}
        run: ./mvnw -B clean install -Pit

      - name: Build and validate extension (Native compatibility)
        if: ${{ inputs.validate-native }}
        run: |
          echo "Building extension JARs and validating native compatibility..."
          ./mvnw -B clean install -Pit -Dnative
          echo "✓ Extension is compatible with native compilation"
        env:
          GRAALVM_HOME: ${{ env.GRAALVM_HOME }}

      - name: Create Git tag
        run: |
          git tag -a v${{ inputs.version }} -m "Release version ${{ inputs.version }}"
          git push origin v${{ inputs.version }}

      - name: Create GitHub Release (Extension JARs)
        if: ${{ !inputs.validate-native }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release ${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            runtime/target/quarkus-easy-nats-${{ inputs.version }}.jar
            deployment/target/quarkus-easy-nats-deployment-${{ inputs.version }}.jar
          generate_release_notes: true
          body: |
            ## Quarkus Extension Release

            This release contains the EasyNATS Quarkus extension JARs:
            - `quarkus-easy-nats-${{ inputs.version }}.jar` (runtime)
            - `quarkus-easy-nats-deployment-${{ inputs.version }}.jar` (deployment)

            ### Usage
            Add to your Quarkus application's `pom.xml`:
            ```xml
            <dependency>
              <groupId>org.mjelle.quarkus.easynats</groupId>
              <artifactId>quarkus-easy-nats</artifactId>
              <version>${{ inputs.version }}</version>
            </dependency>
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (Native-Validated Extension)
        if: ${{ inputs.validate-native }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release ${{ inputs.version }} (Native-Validated)
          draft: false
          prerelease: false
          files: |
            runtime/target/quarkus-easy-nats-${{ inputs.version }}.jar
            deployment/target/quarkus-easy-nats-deployment-${{ inputs.version }}.jar
          generate_release_notes: true
          body: |
            ## Quarkus Extension Release (Native-Validated ✓)

            This release contains the EasyNATS Quarkus extension JARs:
            - `quarkus-easy-nats-${{ inputs.version }}.jar` (runtime)
            - `quarkus-easy-nats-deployment-${{ inputs.version }}.jar` (deployment)

            **Native Compatibility:** This release has been validated for native image compilation with Mandrel ${{ matrix.mandrel-version || '23.1.5.0-Final' }}.

            ### Usage
            Add to your Quarkus application's `pom.xml`:
            ```xml
            <dependency>
              <groupId>org.mjelle.quarkus.easynats</groupId>
              <artifactId>quarkus-easy-nats</artifactId>
              <version>${{ inputs.version }}</version>
            </dependency>
            ```

            ### Native Builds
            Your application can be compiled to native:
            ```bash
            ./mvnw package -Dnative
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set next development version
        run: |
          ./mvnw -B versions:set -DnewVersion=${{ inputs.next-version }} -DprocessAllModules=true
          git add pom.xml */pom.xml
          git commit -m "chore: prepare next development version ${{ inputs.next-version }}"
          git push origin

      - name: Publish to GitHub Packages
        run: ./mvnw -B deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
